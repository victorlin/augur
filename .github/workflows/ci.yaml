name: CI
on:
  push:

  # Routinely check that tests pass with new versions of dependencies.
  schedule:
    # Every day at 17:42 UTC / 9:42 Seattle (winter) / 10:42 Seattle (summer)
    - cron: "42 17 * * *"

  pull_request:

  workflow_dispatch:

  workflow_call:
    inputs:
      version:
        required: true
        type: string

jobs:
  pytest-cram:
    name: pytest-cram (${{ matrix.conda-args }} ${{ matrix.pip-args }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # All supported Python versions with the earliest compatible versions
          # of Biopython¹ and Numpy²
          # ¹ <https://github.com/biopython/biopython/blob/master/NEWS.rst>
          # ² <https://numpy.org/doc/stable/release>
          - { conda-args: 'python=3.9',  pip-args: 'biopython==1.80 numpy==1.19.4' }  # Biopython 1.79 is the first to support Python 3.9, but Augur requires >=1.80
          - { conda-args: 'python=3.10', pip-args: 'biopython==1.80 numpy==1.21.3' }
          - { conda-args: 'python=3.11', pip-args: 'biopython==1.80 numpy==1.23.4' }  # numpy 1.23.2-3 did not declare support in conda
          - { conda-args: 'python=3.12', pip-args: 'biopython==1.82 numpy==1.26.0' }
          - { conda-args: 'python=3.13', pip-args: 'biopython==1.85 numpy==2.1.0'  }
          # Latest versions of Biopython and Numpy
          - { conda-args: 'python=3.13', pip-args: 'biopython numpy'               }
          # Latest Biopython with Numpy v1
          - { conda-args: 'python=3.12', pip-args: 'biopython numpy==1.*'          }

    defaults:
      run:
        shell: bash -l {0}

    steps:
    - uses: actions/checkout@v6

    - name: Set cache key
      run: echo "DATE=$(date +'%Y-%m-%d')" >> "$GITHUB_ENV"

    # While it may be tempting to install Augur using Conda to avoid hardcoding
    # the list of dependencies here, installing just the dependencies not
    # available on PyPI allows us to test against dependencies installed by pip,
    # which may have slightly different versions compared to Conda counterparts.
    - name: Install dependencies from Conda
      uses: mamba-org/setup-micromamba@v2
      with:
        create-args: >-
          mafft raxml fasttree iqtree vcftools seqkit sqlite tsv-utils
          ${{ matrix.conda-args }}
        condarc: |
          channels:
            - conda-forge
            - bioconda
          channel_priority: strict
        cache-environment: true
        cache-environment-key: ${{ env.DATE }}
        environment-name: augur

    # Install the local version of Augur and Python dependencies.
    - run: pip install .[dev] ${{ matrix.pip-args }}
    - run: pip list
    - run: conda info
    - run: conda list

    # Run with coverage on the earliest supported Python version
    - name: Set coverage environment variables
      if: contains(matrix.conda-args, 'python=3.9')
      run: |
        coverage_id="$(printf '%s' "${{ matrix.conda-args }}|${{ matrix.pip-args }}" | sha256sum | cut -d' ' -f1)"
        echo "COVERAGE_FILE=${{ github.workspace }}/.coverage@${coverage_id}" >> "$GITHUB_ENV"
        echo "COVERAGE_RCFILE=${{ github.workspace }}/.coveragerc" >> "$GITHUB_ENV"
        if python3 -c 'import sys; print(sys.version_info >= (3, 14))' | grep -q True; then
            echo "Using sysmon for coverage to reduce overhead"
            echo COVERAGE_CORE=sysmon >> "$GITHUB_ENV"
        else
            echo "Using default coverage collection method"
        fi

    - name: Run pytest
      run: |
        if [[ -n "${COVERAGE_FILE:-}" ]]; then
          echo "Running pytest with coverage enabled"
          pytest --cov=augur
        else
          echo "Running pytest without coverage"
          pytest --no-cov
        fi
    - name: Run cram tests
      run: |
        if [[ -n "${COVERAGE_FILE:-}" ]]; then
          echo "Running cram tests with coverage enabled"
          export AUGUR="coverage run -a ${{ github.workspace }}/bin/augur"
        else
          echo "Running cram tests without coverage"
          export AUGUR="${{ github.workspace }}/bin/augur"
        fi
        cram tests/
    - name: Upload coverage
      if: env.COVERAGE_FILE
      uses: actions/upload-artifact@v6
      with:
        name: coverage
        include-hidden-files: true
        path: "${{ env.COVERAGE_FILE }}"
